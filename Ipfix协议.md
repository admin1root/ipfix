# ipfix协议

IP数据流信息导出（IPFIX）协议，该协议用作在网络上传输流量信息的一种方式。 为了将数据流信息从输出过程传输到收集过程，需要流数据的通用表示形式以及传达它们的标准方法。 本文档描述了IPFIX数据和模板记录如何通过多种传输协议从IPFIX导出过程传送到IPFIX收集过程。

## 简介

数据网络上的流量可视为由流经网络元素的流组成。 出于管理或其他目的，访问有关通过网络元素的这些流的信息通常很有趣，有用，甚至必要。 收集过程应该能够接收通过数据网络内多个网络元素传递的流信息。 这要求在表示流信息的方法和将流从网络元件传递到收集点的手段上保持一致。 本文档指定了实现这些要求的协议。 本文档详细说明了不同流的表示形式，以及流解释，数据包格式，使用的传输机制，安全问题等所需的其他数据。

## 术语

#### Observation Point（观察点）
捕获IP报文的地方。具体到设备上，观测点可以指定到交换机或路由器的每个端口上。
每一个观察点都和一个观察域相关联，并且一个观察点可以是其他几个观察点的超集。例如，一个线卡接入点，是其他线卡接口观察点的超集。

#### Observation Domain（观察域）
观察域是数据流信息能被测定过程聚合的最大的观察点集合。每次输出过程输出的ipfix报文中，观察域的id都是唯一的。这样，收集过程可以通过观察域id确定一个观察域。

#### Packet Treatment（包处理）
包处理指转发设备或中间盒对包的处理。包括转发、丢弃或因为流量整理的延时。

#### Traffic Flow or Flow（流）
IPFIX对流的定义：在一定时间间隔内，经过观察点的一系列IP包。属于同一个流的IP包具有以下一些共同属性：
> 某些IP层头字段（例如目的IP地址）、传输层头字段（例如目的端口）、或应用层头字段（例如RTP头字段）

> 包自身的某些特征（例如MPLS标签号）

> 跟路由器对包处理方式相关字段（例如下一跳IP地址、输出接口）。

#### Flow Key（流键）
每个字段分别为：
> 属于数据包头（例如，目标IP地址）

> 是数据包本身的属性（例如，数据包长度）

> 继承自数据包处理（例如，自治系统（AS）数）

用来定义流（即对流中所有包都通用的属性）称为流键。例如由源IP、目的IP、源端口、目的端口、传输层协议构成的传统的“五元组”流键将属于单个通信方向的所有数据包组合到一个套接字上。

#### Flow Record（流记录）
一个流记录包含了一个观察点上的特定流的信息。流记录包含了流的测定属性（例如，流的字节总数）并且通常包含流的特征（例如，源IP地址）。

#### Metering Process（测定过程）
IP 数据流的解析处理过程，测定过程生成流记录。
计量过程由一组功能组成，这些功能包括数据包头捕获，时标技术，采样，分类和维护流记录。
流记录的维护可能包括创建新记录，更新现有记录，计算流统计信息，推导其他流属性，检测流到期，将流记录传递到导出过程以及删除流记录。

#### Exporting Process（输出过程）
发送IPFIX消息给收集过程。消息中的流记录是由一个或多个测定过程生成的。

#### Exporter（输出器）
承载一个或多个输出过程的设备称为输出器。

#### IPFIX Device（IPFIX设备）
IPFIX设备至少托管一个输出过程。 它可以承载进一步的输出过程以及任意数量的观察点和测定过程。

#### Collecting Process（收集过程）
收集过程从一个或多个导出过程接收IPFIX消息。 收集过程可能会处理或存储在这些消息中收到的流记录。

#### Collector（收集者）
承载一个或多个收集过程

#### Template（模板）
指定了需要从IPFIX设备传送到收集者的特定信息集的结构和语义，是一个<type, length>对的有序序列。每个模板都可以通过模板ID进行唯一标识。

#### IPFIX Message（IPFIX消息）
IPFIX消息由输出过程中生成，包含有该输出过程IPFIX记录，并被发送到收集过程。IPFIX消息封装在传输层。

#### Message Header（消息头）
提供IPFIX消息的基本信息：IPFIX版本，消息长度，消息序号等

#### Template Record（模板记录）
模板记录定义了数据记录中字段的结构和解释

#### Data Record（数据记录）
数据记录是包含与模板记录相对应的参数值的记录。

#### Options Template Record(选项模板记录)
选项模板记录是一种模板记录，它定义数据记录中字段的结构和解释，包括定义如何确定数据记录的适用范围。

#### Set(集)
有相同结构的记录的集合，有个头前缀。有三种set：
> Template Set：模板集是一个或多个在IPFIX消息中分组在一起的模板记录的集合。

> Options Template Set:选项模板集是一个或多个在IPFIX消息中分组在一起的选项模板记录的集合。

> Data Set:数据集是一个或多个相同类型的数据记录，它们在IPFIX消息中分组在一起。 每个数据记录都预先由模板记录或选项模板记录定义。

#### Information Element（信息元素）
信息元素是IPFIX记录中可能出现的与协议和编码无关的属性。 ~~信息元素在IANA“ IPFIX信息元素”注册表[IANA-IPFIX]中定义。 与信息元素关联的类型指示对其可能包含的内容的约束，并且还确定要在IPFIX中使用的有效编码机制。~~

#### Transport Session（传输会话）
在流控制传输协议（SCTP）中，传输会话称为SCTP关联，由SCTP端点唯一标识[RFC4960]； 在TCP中，传输会话称为TCP连接，由IP地址和所用TCP端口的组合唯一标识。 在UDP中，传输会话称为UDP会话，由IP地址和所用UDP端口的组合唯一标识。

### 术语汇总表
    +------------------+---------------------------------------------+
    |                  |                 Contents                    |
    |                  +--------------------+------------------------+
    |       Set        |      Template      |         Record         |
    +------------------+--------------------+------------------------+
    |     Data Set     |          /         |     Data Record(s)     |
    +------------------+--------------------+------------------------+
    |   Template Set   | Template Record(s) |           /            |
    +------------------+--------------------+------------------------+
    | Options Template |  Options Template  |           /            |
    |       Set        |      Record(s)     |                        |
    +------------------+--------------------+------------------------+
    
  
    
  数据集由数据记录组成。 不包括模板记录。 模板记录或选项模板记录定义了数据记录。

  模板集仅包含模板记录。

  选项模板集仅包含选项模板记录。

## IPFIX消息格式
IPFIX消息由消息头和后面的零个或多个Set组成。 这些Set可以是以下三种可能的类型中的任何一种：数据集，模板集或选项模板集。
IPFIX消息格式如下：

         +----------------------------------------------------+
         | Message Header                                     |
         +----------------------------------------------------+
         | Set                                                |
         +----------------------------------------------------+
         | Set                                                |
         +----------------------------------------------------+
           ...
         +----------------------------------------------------+
         | Set                                                |
         +----------------------------------------------------+

 
一些例子：
   1. 一个IPFIX消息，由交错的模板，数据和选项模板集组成。这里，模板和选项模板集“按需”传输，在它们定义其结构的第一个数据集之前
   
     +--------+--------------------------------------------------------+
     |        | +----------+ +---------+     +-----------+ +---------+ |
     |Message | | Template | | Data    |     | Options   | | Data    | |
     | Header | | Set      | | Set     | ... | Template  | | Set     | |
     |        | |          | |         |     | Set       | |         | |
     |        | +----------+ +---------+     +-----------+ +---------+ |
     +--------+--------------------------------------------------------+
       
   2. 定义了适当的模板记录后发送的，完全由数据集组成的IPFIX消息，并将其传输到收集过程
   
    +--------+----------------------------------------------+
    |        | +---------+     +---------+      +---------+ |
    |Message | | Data    |     | Data    |      | Data    | |
    | Header | | Set     | ... | Set     | ...  | Set     | |
    |        | +---------+     +---------+      +---------+ |
    +--------+----------------------------------------------+
       
   3. IPFIX消息，完全由模板和选项模板集组成。此类消息可用于批量定义或重新定义模板和选项模板。
   
    +--------+-------------------------------------------------+
    |        | +----------+     +----------+      +----------+ |
    |Message | | Template |     | Template |      | Options  | |
    | Header | | Set      | ... | Set      | ...  | Template | |
    |        | |          |     |          |      | Set      | |
    |        | +----------+     +----------+      +----------+ |
    +--------+-------------------------------------------------+
       

### 消息头格式
消息头格式如下：

      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |       Version Number          |            Length             |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                           Export Time                         |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                       Sequence Number                         |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                    Observation Domain ID                      |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     

每个消息头字段均已网络字节序导出。
字段说明：
* **版本号**：IPFIX消息版本号
* **消息长度**：IPFIX消息的总长度，单位是字节，包括消息头和集合
* **输出时间**：IPFIX消息头离开输出器的时间，时间戳格式，编码为32位无符号整数。
* **序列号**：通过输出过程从当前观察域在当前流中发送的所有IPFIX数据记录的2 ^ 32模的递增序列计数器，每个SCTP流分别计算序列号，而TCP连接或UDP会话中的所有消息均被视为同一流的一部分。 收集过程可以使用此值来识别是否遗漏了任何IPFIX数据记录。 模板和选项模板记录不会增加序列号。
* **观察域ID**：观察域的32位标识符，对于输出过程是本地唯一的。 输出过程使用观察域ID向收集过程唯一标识对流量进行计量的观察域。 建议该标识符对于每个IPFIX设备也是唯一的。 收集过程应该使用传输会话和观察域ID字段来分隔源自同一输出器的不同出口流。 当没有特定的观察域ID与整个IPFIX消息相关时，观察域ID应该为0，例如，在导出输出过程统计信息时，或者在收集器层次结构的情况下，当导出聚合数据记录时。

### 字段说明符（Field Specifier）格式
供应商需要具有定义专有信息元素的能力，因为例如，他们正在交付标准产品，或者信息元素在某种程度上对商业敏感。 本部分描述了IANA注册的信息元素[IANA-IPFIX]和企业特定信息元素的字段说明符格式。
格式如下：

    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |E|  Information Element ident. |        Field Length           |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |                      Enterprise Number                        |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     
说明：
* **E**:企业位。 这是字段说明符的第一位。 如果该位为零，则信息元素标识符在[IANA-IPFIX]中标识一个信息元素，并且必须不存在四字节的企业编号字段。 如果该位为1，则信息元素标识符标识企业特定的信息元素，并且企业编号字段必须存在。
* **Information Element identifier**:信息元素表示符。代表信息元素的数值。 请参阅[IANA-IPFIX]。
* **Field Length**:相应编码信息元素的长度，以字节为单位。 请参阅[IANA-IPFIX]。 如果使用减小尺寸的编码，则字段长度可能小于[IANA-IPFIX]中列出的长度（请参见6.2节）。 值65535为可变长度的信息元素保留（请参见第7节）。
* **Enterprise Number**:定义此模板记录中信息元素标识符的授权机构的IANA企业编号[IANA-PEN]。

### Set和Set头格式
Set是具有相似结构的记录集合的通用术语。 共有三种不同类型的集：模板集，选项模板集和数据集。 这些集合中的每一个都由一个Set头和一个或多个记录组成。

#### Set格式
记录类型可以是“模板记录”，“选项模板记录”或“数据记录”，但一个set中的记录类型只能是一种类型，不能混合使用。

           +--------------------------------------------------+
           | Set Header                                       |
           +--------------------------------------------------+
           | record                                           |
           +--------------------------------------------------+
           | record                                           |
           +--------------------------------------------------+
            ...
           +--------------------------------------------------+
           | record                                           |
           +--------------------------------------------------+
           | Padding (opt.)                                   |
           +--------------------------------------------------+
           
Set头和记录下面章节介绍。
* **Padding**：输出过程可以插入一些填充字节，以便随后的Set从对齐的边界开始。 出于安全原因，填充字节必须由值为零（0）的字节组成。 填充长度必须短于此Set中任何允许的记录。 如果需要结合非常短的记录来填充IPFIX消息，则可以将填充信息元素'paddingOctets'用于填充记录，以使它们的长度增加到4或8个八位位组的倍数。 由于模板集始终按定义对齐4个八位位组，因此仅在其他对齐方式（例如在8个八位组的边界上）才需要填充。

#### set头格式
每个集都包含一个公共头，格式如下：

      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |          Set ID               |          Length               |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     
说明：
* **Set ID**:集ID标识集。2：模板集，3:选项模板集，4-255保留备用。256及以上为数据集。由于历史原因，0-1未使用。
* **Length**:Set的总长度，以字节为单位，包括集头部，包括所有记录和填充。 因为一个单独的集合可以包含多个记录，所以长度值必须用于确定下一个集合的位置。

### 记录格式
IPFIX定义了三种记录格式：模板记录格式、可选模板记录格式和数据记录格式。
#### 模板记录格式
模板极大地提高了记录格式的灵活性，因为它们允许收集过程处理IPFIX消息，而不必知道所有数据记录。 模板记录包含IANA分配的和/或企业特定的信息元素标识符的任意组合。

           +--------------------------------------------------+
           | Template Record Header                           |
           +--------------------------------------------------+
           | Field Specifier                                  |
           +--------------------------------------------------+
           | Field Specifier                                  |
           +--------------------------------------------------+
            ...
           +--------------------------------------------------+
           | Field Specifier                                  |
           +--------------------------------------------------+
           
模板记录包含一个模板记录头部和一个或多个字段说明符。字段说明符的格式已经在上面介绍过了，模板记录头部的格式如下：

     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |      Template ID (> 255)      |         Field Count           |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    
模板记录头部字段说明：

* **Template ID**:唯一标识模板，取值范围256-65535。这种唯一性对于生成模板ID的传输会话和观察域是本地的。由于模板ID在它们描述的集中用作集ID，因此值0-255保留用于特殊的集类型（例如，模板集合本身）以及模板和选项模板不能在传输会话和观察域内共享模板ID。模板ID分配的顺序没有任何限制。 由于输出流程可以自由分配自己认为合适的模板ID，因此收集过程一定不能假定增量模板ID或仅基于模板ID来了解模板内容的任何内容。

* **Field Count**:模板记录中的字段说明符数量。

下面的示例显示了一个模板集，其中包含分配的IANA和企业特定的混合信息元素。 它由一个集头部，一个模板头部和几个字段说明符组成。

      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |          Set ID = 2           |          Length               |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |      Template ID = 256        |         Field Count = N       |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |1| Information Element id. 1.1 |        Field Length 1.1       |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                    Enterprise Number  1.1                     |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |0| Information Element id. 1.2 |        Field Length 1.2       |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |             ...               |              ...              |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |1| Information Element id. 1.N |        Field Length 1.N       |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                    Enterprise Number  1.N                     |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |      Template ID = 257        |         Field Count = M       |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |0| Information Element id. 2.1 |        Field Length 2.1       |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |1| Information Element id. 2.2 |        Field Length 2.2       |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                    Enterprise Number  2.2                     |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |             ...               |              ...              |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |1| Information Element id. 2.M |        Field Length 2.M       |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                    Enterprise Number  2.M                     |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                          Padding (opt)                        |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     
信息元素id 1.2和2.1出现在[IANA-IPFIX]（企业位= 0）中，因此不需要企业编号来标识它们。

#### 选项模板记录格式
多亏了范围的概念，“选项模板记录”使导出器能够向收集器提供其他信息，而仅凭“流记录”是不可能的。
特定选项模板被用于报告输出过程和测定过程元数据的相关内容，请看第四章

##### 作用域（Scope）
作用域仅在“选项模板集”中可用，提供了数据记录中报告的信息元素的上下文。
作用域是在选项模板记录中指定的一个或多个信息元素。 收集流程至少应支持将observationDomainId，exportingProcessId，meteringProcessId，templateId，lineCardId，exporterIPv4Address，exporterIPv6Address和ingressInterface信息元素作为作用域。 IPFIX协议不会阻止将任何信息元素用于作用域。 但是，如果将某些信息元素类型指定为作用域，则没有任何意义（例如，计数器信息元素）。
IPFIX消息头已经包含观察域ID。 如果不为零，则可以将该观察域ID视为IPFIX消息中数据记录的隐式范围。
选项模板记录中可能存在多个合并作用域字段，在这种情况下，组合合并作用域是合并作用域的组合。例如，如果两个合并作用域是meteringProcessId和templateId，则合并合并作用域是此计量过程的此模板。 如果作用域字段的不同顺序导致记录具有不同的语义，则作用域字段的顺序必须由输出过程保留。 例如，在PSAMP [RFC5476]的上下文中，如果第一个作用域定义了过滤功能，而第二个作用域定义了采样功能，则作用域的顺序很重要。 首先应用采样功能
其次是过滤功能，与首先应用过滤功能，然后是采样功能相比，可能导致潜在的数据记录不同。
