
## 8.模板管理
本节介绍了在输出和收集过程中对模板和选项模板的管理。 模板管理的目标是尽可能确保输出过程和收集过程对模板和选项模板具有一致的视图，该模板和选项模板用于对从输出过程发送到收集过程的记录进行编码和解码。

实现此目标的过程有些复杂，有两个因素：1）需要支持在传输会话中重用模板ID，2）当使用UDP作为IPFIX消息的传输协议时，需要支持模板的不可靠传输。

本节中定义的模板管理机制适用于在SCTP，TCP或UDP上导出IPFIX消息。 第8.3节和第8.4节分别给出了SCTP和UDP传输特定的其他注意事项。

输出过程为每个传输会话和观察域分配并维护模板ID。 输出过程为新创建的模板记录分配了未使用的模板ID。 收集过程必须存储每个传输会话期间所有接收到的模板记录信息，直到第8.1节中所述的重用或退出，或第8.4节中所述的UDP到期为止，以便它可以解释相应的数据记录。

收集过程不得假定来自给定输出过程的模板ID引用的模板与先前来自同一输出过程的传输会话中的模板相同； 收集过程一定不能使用一个传输会话中的模板来解码后续传输会话中的数据集。

如果模板需要特定的信息元素，但在观察到的数据包中不存在该信息元素，则输出过程可以选择在新模板描述的数据记录中输出不包含该信息元素的流记录。

如果在一个模板中不止一次需要一个信息元素，则该信息元素的不同出现应遵循测定过程对其处理的逻辑顺序。 例如，如果选定的数据包通过两个哈希函数，并且如果两个哈希值在单个模板中发送，则哈希值的首次出现应属于测定过程中的第一个哈希函数。 例如，当输出IPv4-in-IPv4数据包的两个源IP地址时，第一个sourceIPv4Address信息元素出现应为外部标头的IPv4地址，而第二次出现应为内部标头的地址。 收集过程必须正确处理具有多个相同信息元素的模板。

输出过程应该先传送模板集或选项模板集，再传送使用该模板id的数据集，以帮助确保收集器在收到第一个数据记录之前具有模板记录。对应于数据记录，可以出在该模板记录的同一个ipfix消息中，也可以在后续的消息中。 但是，收集过程不得假定数据集和关联的模板集（或选项模板集）在同一IPFIX消息中输出。

尽管收集进程通常在接收数据记录之前先从输出过程接收模板记录，但这并非总是如此，例如，在重新排序或通过UDP重新启动收集过程的情况下。 在这些情况下，收集过程可以缓存没有模板的数据记录，以等待描述它们的模板记录。 但是，请注意，在撤消和重新定义模板的情况下（第8.1节），这可能会导致对数据记录的错误解释。

传输会话中的不同观察域可以使用相同的模板ID值来指向不同的模板。 收集过程必须正确处理这种情况。

有依赖关系的选项模板和模板必须在同一个ipfix消息中发送。

### 8.1模板的撤销和重新定义
输出过程中的模板不再使用，可以通过发送模板撤销信令来撤销模板。收到撤销模板信令后，收集过程必须停止使用模板来解释随后输出的数据集。请注意，当使用UDP传输IPFIX消息时，此机制不适用。 对于这种情况，请参见第8.4节。

撤销模板由包含被撤销模板id和Field Count（字段数量）为0的模板记录组成。撤销模板的格式如下：

     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |       Set ID = (2 or 3)       |          Length = 16          |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |          Template ID N        |        Field Count = 0        |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |          Template ID ...      |        Field Count = 0        |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |          Template ID M        |        Field Count = 0        |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    
集ID为2，撤销模板，集ID为3，撤销选项模板。可以一次撤销多个模板，这种情况下，可能会用到填充（Padding）。

当模板撤销、选项模板撤销和数据集交错出现时，按照ipfix消息中的出现顺序进行处理。 除非预留足够的时间以允许接收和处理由撤回的模板描述的任何数据记录，否则导出过程不应发送撤回模板； 有关模板管理操作顺序的详细信息，请参见第8.2节。

传输会话的末尾隐式撤回了传输会话中使用的所有模板，并且在输出过程和收集过程之间的后续传输会话期间，必须重新发送模板。 这仅适用于SCTP和TCP。 有关UDP上的传输会话和模板生存期的讨论，请参见8.4和10.3.4节。

给定观察域的所有模板和选项模板都可以全部撤回，格式如下：

      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |             Set ID = 2        |          Length = 8           |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |         Template ID = 2       |        Field Count = 0        |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     
      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |             Set ID = 3        |          Length = 8           |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |         Template ID = 3       |        Field Count = 0        |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     
模板撤回后，模板id可以被重用。

如果收集过程受到一个不存在的模板的模板撤回信令，则说明输出过程有故障或执行错误。收集过程仍然可以继续接收和解释数据记录，但是必须忽略模板撤销，并记录错误。

如果一个收集过程接收到一个新的模板记录或选项模板记录，该记录或选项模板记录的模板ID已分配过，并且该模板或选项模板与已经接收的模板或选项模板相同，则它应该记录重传； 但是，这不是错误条件，因为它不会影响数据记录的解释。

如果收集过程接收到有关已分配的模板ID的新模板记录或选项模板记录，并且该模板或选项模板与已接收的模板或选项模板不同，则表明输出过程有故障或执行不正确。 不可能继续接收和明确解释此模板ID的数据记录，并且“收集过程”应记录该错误。 进一步的“收集过程”操作超出了本规范的范围。

### 8.2模板管理操作的排序

由于SCTP或UDP输出IPFIX消息不能保证顺序，因此输出过程必须使用IPFIX消息头部中的输出时间（Export Time）字段对所有模板管理操作（即定义新模板的模板记录和撤消它们的模板撤消操作）进行排序。

输出过程不得在包含该模板的IPFIX消息的输出时间之前输出IPFIX消息中新模板描述的数据集。 如果新的模板及其描述的数据集出现在同一IPFIX消息中，则包含模板的模板集必须出现在消息中的数据集之前。

输出过程不得在IPFIX消息的输出时间（包含撤消该模板的模板的IPFIX消息的输出时间）之后输出IPFIX消息中已撤消模板描述的任何数据集。

换句话说，当IPFIX消息的输出时间介于特定的开始时间和结束时间（包括开始时间和结束时间）之间时，模板将描述IPFIX消息中包含的数据记录。 开始时间是包含模板记录的IPFIX消息的输出时间。 结束时间是以下两次之一：如果在会话期间撤回了模板，则它是IPFIX消息的输出时间，其中包含该模板的撤回模板； 否则，这是传输会话的结束。

即使按顺序发送，包含模板管理操作的IPFIX消息也可能会无序到达收集过程，例如通过UDP或通过不同的SCTP流发送的。 鉴于此，模板撤销和模板ID的后续重用会使在收集过程中确定模板生存期的问题严重复杂化。 收集过程可以实现一个缓冲区，并使用输出时间信息来确定模板管理动作的顺序。 如果实现了该缓冲区，则应该配置为赋予一个延迟，该延迟的大小与收集过程中遇到的最大重排序延迟相同。 请注意，在这种情况下，收集过程的时钟是无关紧要的：它只是在相互比较消息的输出时间。

### 8.3通过SCTP进行模板管理的其他注意事项

### 8.4通过UDP进行模板管理的其他注意事项
     
