
## 8.模板管理
本节介绍了在输出和收集过程中对模板和选项模板的管理。 模板管理的目标是尽可能确保输出过程和收集过程对模板和选项模板具有一致的视图，该模板和选项模板用于对从输出过程发送到收集过程的记录进行编码和解码。

实现此目标的过程有些复杂，有两个因素：1）需要支持在传输会话中重用模板ID，2）当使用UDP作为IPFIX消息的传输协议时，需要支持模板的不可靠传输。

本节中定义的模板管理机制适用于在SCTP，TCP或UDP上导出IPFIX消息。 第8.3节和第8.4节分别给出了SCTP和UDP传输特定的其他注意事项。

输出过程为每个传输会话和观察域分配并维护模板ID。 输出过程为新创建的模板记录分配了未使用的模板ID。 收集过程必须存储每个传输会话期间所有接收到的模板记录信息，直到第8.1节中所述的重用或退出，或第8.4节中所述的UDP到期为止，以便它可以解释相应的数据记录。

收集过程不得假定来自给定输出过程的模板ID引用的模板与先前来自同一输出过程的传输会话中的模板相同； 收集过程一定不能使用一个传输会话中的模板来解码后续传输会话中的数据集。

如果模板需要特定的信息元素，但在观察到的数据包中不存在该信息元素，则输出过程可以选择在新模板描述的数据记录中输出不包含该信息元素的流记录。

如果在一个模板中不止一次需要一个信息元素，则该信息元素的不同出现应遵循测定过程对其处理的逻辑顺序。 例如，如果选定的数据包通过两个哈希函数，并且如果两个哈希值在单个模板中发送，则哈希值的首次出现应属于测定过程中的第一个哈希函数。 例如，当输出IPv4-in-IPv4数据包的两个源IP地址时，第一个sourceIPv4Address信息元素出现应为外部标头的IPv4地址，而第二次出现应为内部标头的地址。 收集过程必须正确处理具有多个相同信息元素的模板。

输出过程应该先传送模板集或选项模板集，再传送使用该模板id的数据集，以帮助确保收集器在收到第一个数据记录之前具有模板记录。对应于数据记录，可以出在该模板记录的同一个ipfix消息中，也可以在后续的消息中。 但是，收集过程不得假定数据集和关联的模板集（或选项模板集）在同一IPFIX消息中输出。

尽管收集进程通常在接收数据记录之前先从输出过程接收模板记录，但这并非总是如此，例如，在重新排序或通过UDP重新启动收集过程的情况下。 在这些情况下，收集过程可以缓存没有模板的数据记录，以等待描述它们的模板记录。 但是，请注意，在撤消和重新定义模板的情况下（第8.1节），这可能会导致对数据记录的错误解释。

传输会话中的不同观察域可以使用相同的模板ID值来指向不同的模板。 收集过程必须正确处理这种情况。

有依赖关系的选项模板和模板必须在同一个ipfix消息中发送。

### 8.1模板的撤销和重新定义
输出过程中的模板不再使用，可以通过发送模板撤销信令来撤销模板。收到撤销模板信令后，收集过程必须停止使用模板来解释随后输出的数据集。请注意，当使用UDP传输IPFIX消息时，此机制不适用。 对于这种情况，请参见第8.4节。

撤销模板由包含被撤销模板id和Field Count（字段数量）为0的模板记录组成。撤销模板的格式如下：

     0                   1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |       Set ID = (2 or 3)       |          Length = 16          |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |          Template ID N        |        Field Count = 0        |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |          Template ID ...      |        Field Count = 0        |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |          Template ID M        |        Field Count = 0        |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    
集ID为2，撤销模板，集ID为3，撤销选项模板。可以一次撤销多个模板，这种情况下，可能会用到填充（Padding）。

当模板撤销、选项模板撤销和数据集交错出现时，按照ipfix消息中的出现顺序进行处理。 除非预留足够的时间以允许接收和处理由撤回的模板描述的任何数据记录，否则导出过程不应发送撤回模板； 有关模板管理操作顺序的详细信息，请参见第8.2节。

传输会话的末尾隐式撤回了传输会话中使用的所有模板，并且在输出过程和收集过程之间的后续传输会话期间，必须重新发送模板。 这仅适用于SCTP和TCP。 有关UDP上的传输会话和模板生存期的讨论，请参见8.4和10.3.4节。
